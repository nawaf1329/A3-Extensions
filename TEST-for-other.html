<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>A3 Directory</title>
<link rel="icon" type="image/png" href="logo.png">

<style>
:root {
  /* Dark Professional Theme */
  --bg-primary: #0B0F19;
  --bg-secondary: #151B2B;
  --bg-card: #1E2538;
  --bg-hover: #252D42;
  
  /* Accents */
  --accent-cyan: #00D4AA;
  --accent-blue: #0EA5E9;
  --accent-purple: #8B5CF6;
  --accent-rrt: #EF4444;
  
  /* Text */
  --text-primary: #F1F5F9;
  --text-secondary: #94A3B8;
  --text-muted: #64748B;
  
  /* Spacing */
  --space-xs: 0.25rem;
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;
  
  /* Radius */
  --radius-sm: 0.5rem;
  --radius-md: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.25rem;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  font-size: 16px;
  background: var(--bg-primary);
  height: 100%;
  overflow: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100%;
  overflow: hidden;
  line-height: 1.5;
}

/* ================= APP CONTAINER ================= */
.app {
  height: 100%;
  display: flex;
  flex-direction: column;
  max-width: 600px;
  margin: 0 auto;
  background: var(--bg-primary);
}

/* ================= COMPACT HEADER ================= */
.header {
  padding: var(--space-md) var(--space-md) var(--space-sm);
  background: var(--bg-secondary);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-md);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.logo-box {
  width: 2.25rem;
  height: 2.25rem;
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-box img {
  width: 1.5rem;
  height: 1.5rem;
  object-fit: contain;
  filter: brightness(0) invert(1);
}

.title h1 {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}

.title p {
  font-size: 0.6875rem;
  color: var(--text-muted);
}

/* ================= EMERGENCY BAR ================= */
.emergency-bar {
  display: flex;
  gap: var(--space-md);
  padding: var(--space-sm);
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-sm);
}

.emergency-item {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-xs);
  padding: var(--space-xs) var(--space-sm);
  background: rgba(239, 68, 68, 0.15);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 150ms ease;
}

.emergency-item:active {
  transform: scale(0.98);
  background: rgba(239, 68, 68, 0.25);
}

.emergency-dot {
  width: 6px;
  height: 6px;
  background: var(--accent-rrt);
  border-radius: 50%;
  animation: blink 1.5s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.emergency-item span {
  font-size: 0.625rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  font-weight: 600;
}

.emergency-item strong {
  font-family: 'SF Mono', monospace;
  font-size: 0.875rem;
  color: #fff;
  font-weight: 700;
}

/* ================= SEARCH SECTION ================= */
.search-section {
  padding: var(--space-sm) var(--space-md);
  background: var(--bg-secondary);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-xl);
  padding: var(--space-sm) var(--space-md);
  transition: all 150ms ease;
}

.search-box:focus-within {
  border-color: var(--accent-cyan);
  box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
}

.search-icon {
  color: var(--text-muted);
  margin-right: var(--space-sm);
  font-size: 1rem;
}

.search-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 0.9375rem;
  outline: none;
}

.search-input::placeholder {
  color: var(--text-muted);
}

.search-clear {
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 50%;
  background: var(--text-muted);
  border: none;
  color: var(--bg-card);
  font-size: 0.625rem;
  cursor: pointer;
  opacity: 0;
  transition: opacity 150ms ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-box.has-value .search-clear {
  opacity: 1;
}

/* ================= FILTER TABS ================= */
.filter-bar {
  display: flex;
  gap: var(--space-xs);
  padding: var(--space-sm) var(--space-md);
  background: var(--bg-secondary);
  overflow-x: auto;
  scrollbar-width: none;
}

.filter-bar::-webkit-scrollbar {
  display: none;
}

.filter-tab {
  flex-shrink: 0;
  padding: var(--space-xs) var(--space-md);
  background: transparent;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-xl);
  color: var(--text-secondary);
  font-size: 0.8125rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 150ms ease;
  white-space: nowrap;
}

.filter-tab.active {
  background: var(--accent-cyan);
  border-color: var(--accent-cyan);
  color: var(--bg-primary);
  font-weight: 600;
}

.filter-tab:active {
  transform: scale(0.95);
}

/* ================= CONTENT LIST ================= */
.content {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-sm);
}

.content::-webkit-scrollbar {
  width: 0;
}

.results-count {
  padding: var(--space-sm) var(--space-md);
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 500;
}

/* Contact Card */
.contact-card {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  padding: var(--space-md);
  margin-bottom: var(--space-xs);
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 150ms ease;
}

.contact-card:active {
  background: var(--bg-hover);
  transform: scale(0.995);
}

.contact-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: linear-gradient(135deg, rgba(0, 212, 170, 0.2), rgba(14, 165, 233, 0.2));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.contact-info {
  flex: 1;
  min-width: 0;
}

.contact-category {
  font-size: 0.6875rem;
  color: var(--accent-cyan);
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.05em;
  margin-bottom: var(--space-xs);
}

.contact-name {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.contact-ext {
  font-family: 'SF Mono', monospace;
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--accent-cyan);
  background: rgba(0, 212, 170, 0.1);
  padding: var(--space-xs) var(--space-sm);
  border-radius: var(--radius-sm);
  flex-shrink: 0;
}

.contact-fav {
  width: 2rem;
  height: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.125rem;
  cursor: pointer;
  transition: all 150ms ease;
  flex-shrink: 0;
}

.contact-fav.active {
  color: #FBBF24;
}

.contact-fav:active {
  transform: scale(0.9);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: var(--space-xl) var(--space-md);
  color: var(--text-muted);
}

.empty-icon {
  width: 4rem;
  height: 4rem;
  margin: 0 auto var(--space-md);
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  opacity: 0.5;
}

.empty-text {
  font-size: 0.875rem;
}

/* ================= PRINTER BUTTON ================= */
.printer-btn {
  position: fixed;
  bottom: calc(var(--space-md) + env(safe-area-inset-bottom));
  right: var(--space-md);
  width: 3rem;
  height: 3rem;
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
  border: none;
  border-radius: 50%;
  color: #fff;
  font-size: 1.25rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  transition: all 150ms ease;
  z-index: 50;
  display: flex;
  align-items: center;
  justify-content: center;
}

.printer-btn:active {
  transform: scale(0.9);
}

/* ================= MODAL ================= */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transition: all 200ms ease;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.modal.active {
  opacity: 1;
  visibility: visible;
}

.modal-sheet {
  width: 100%;
  max-height: 70vh;
  background: var(--bg-secondary);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  transform: translateY(100%);
  transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal.active .modal-sheet {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md) var(--space-md) var(--space-sm);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.modal-title {
  font-size: 1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.modal-close {
  width: 2rem;
  height: 2rem;
  border-radius: var(--radius-md);
  background: var(--bg-card);
  border: none;
  color: var(--text-secondary);
  font-size: 1rem;
  cursor: pointer;
}

.modal-content {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-sm);
}

.printer-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md);
  background: var(--bg-card);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-xs);
  cursor: pointer;
}

.printer-item:active {
  background: var(--bg-hover);
}

.printer-name {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-xs);
}

.printer-loc {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.printer-code {
  font-family: 'SF Mono', monospace;
  font-size: 0.8125rem;
  color: var(--accent-purple);
  background: rgba(139, 92, 246, 0.1);
  padding: var(--space-xs) var(--space-sm);
  border-radius: var(--radius-sm);
}

/* ================= TOAST ================= */
.toast {
  position: fixed;
  top: var(--space-md);
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.1);
  border-left: 3px solid var(--accent-cyan);
  padding: var(--space-sm) var(--space-md);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  color: var(--text-primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  opacity: 0;
  transition: all 300ms ease;
  z-index: 200;
  pointer-events: none;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast.success {
  border-left-color: var(--accent-cyan);
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-top">
      <div class="logo-section">
        <div class="logo-box">
          <img src="logo.png" alt="A3">
        </div>
        <div class="title">
          <h1>A3 Directory</h1>
          <p>KFSH Internal Extensions</p>
        </div>
      </div>
    </div>
    
    <!-- Emergency -->
    <div class="emergency-bar">
      <div class="emergency-item" onclick="copyToClipboard('49337')">
        <div class="emergency-dot"></div>
        <span>Adult</span>
        <strong>49337</strong>
      </div>
      <div class="emergency-item" onclick="copyToClipboard('45381')">
        <div class="emergency-dot"></div>
        <span>Pediatric</span>
        <strong>45381</strong>
      </div>
    </div>
  </header>

  <!-- Search -->
  <div class="search-section">
    <div class="search-box" id="searchBox">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Search name or extension..." autocomplete="off">
      <button class="search-clear" id="clearSearch">‚úï</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <button class="filter-tab active" data-filter="all">All</button>
    <button class="filter-tab" data-filter="fav">‚≠ê Favorites</button>
  </div>

  <!-- Content -->
  <main class="content" id="content">
    <div class="results-count" id="resultsCount">Loading...</div>
    <div id="directoryList"></div>
  </main>

  <!-- Printer Button -->
  <button class="printer-btn" onclick="openPrinterModal()">üñ®Ô∏è</button>

  <!-- Printer Modal -->
  <div class="modal" id="printerModal">
    <div class="modal-sheet">
      <div class="modal-header">
        <div class="modal-title">üñ®Ô∏è Printers</div>
        <button class="modal-close" onclick="closePrinterModal()">‚úï</button>
      </div>
      <div class="modal-content" id="printerList"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>
</div>

<script>
// ================= DATA =================
const STORAGE = {
  data: 'a3_data_v9',
  favorites: 'a3_fav_v9'
};

let state = {
  data: [],
  favorites: new Set(),
  filter: 'all',
  search: ''
};

const printers = [
  { code: 'RINPA0301B', name: 'Label Printer A', loc: 'Nursing Station' },
  { code: 'RNURB0202B', name: 'Label Printer B', loc: 'Pharmacy' },
  { code: 'RNURA0301Z', name: 'Main Printer A3', loc: 'Central' },
  { code: 'NURSE_A3', name: 'Workstation Login', loc: 'A3 PC' },
  { code: 'KFSH#3709', name: 'System Password', loc: 'Access' }
];

// ================= INIT =================
function init() {
  loadLocal();
  setupEvents();
  fetchData();
}

function loadLocal() {
  const favs = localStorage.getItem(STORAGE.favorites);
  if (favs) state.favorites = new Set(JSON.parse(favs));
  
  const data = localStorage.getItem(STORAGE.data);
  if (data) {
    state.data = JSON.parse(data);
    render();
  }
}

// ================= FETCH (ORIGINAL METHOD) =================
function fetchData() {
  const script = document.createElement('script');
  script.src = "https://script.google.com/macros/s/AKfycby9t71TVzAJyzRDczYYtLh7oIIq9J4jEvyddy7Bc-BAunFMTuYEwerlscLHjfKw0orA/exec";
  document.body.appendChild(script);
}

function callback(response) {
  if (!response || !Array.isArray(response)) return;
  
  const newData = JSON.stringify(response);
  const oldData = JSON.stringify(state.data);
  
  if (newData !== oldData) {
    state.data = response;
    localStorage.setItem(STORAGE.data, newData);
    render();
    showToast(`Updated ${response.length} contacts`);
  }
}

// ================= RENDER =================
function render() {
  const list = document.getElementById('directoryList');
  const count = document.getElementById('resultsCount');
  
  let filtered = state.data.filter(item => {
    if (state.filter === 'fav' && !state.favorites.has(makeKey(item))) return false;
    
    if (state.search) {
      const q = state.search.toLowerCase();
      return (
        (item.category || '').toLowerCase().includes(q) ||
        (item.service || '').toLowerCase().includes(q) ||
        (item.extension || '').toLowerCase().includes(q)
      );
    }
    return true;
  });
  
  count.textContent = `${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
  
  if (filtered.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <div class="empty-text">No results found</div>
      </div>
    `;
    return;
  }
  
  list.innerHTML = filtered.map(item => {
    const key = makeKey(item);
    const isFav = state.favorites.has(key);
    const icon = getCategoryIcon(item.category);
    
    return `
      <div class="contact-card" onclick="copyToClipboard('${escape(item.extension)}')">
        <div class="contact-icon">${icon}</div>
        <div class="contact-info">
          <div class="contact-category">${escape(item.category || 'General')}</div>
          <div class="contact-name">${escape(item.service || 'Unknown')}</div>
        </div>
        <div class="contact-ext">${escape(item.extension)}</div>
        <button class="contact-fav ${isFav ? 'active' : ''}" 
                onclick="event.stopPropagation(); toggleFav('${escape(key)}', this)">
          ${isFav ? '‚òÖ' : '‚òÜ'}
        </button>
      </div>
    `;
  }).join('');
}

function getCategoryIcon(cat) {
  const icons = {
    'Nursing': 'üë®‚Äç‚öïÔ∏è',
    'Admin': 'üìã',
    'Tech': 'üîß',
    'Pharmacy': 'üíä',
    'Lab': 'üß™',
    'ER': 'üö®'
  };
  return icons[cat] || 'üè•';
}

// ================= ACTIONS =================
function toggleFav(key, btn) {
  key = unescape(key);
  
  if (state.favorites.has(key)) {
    state.favorites.delete(key);
    btn.classList.remove('active');
    btn.textContent = '‚òÜ';
  } else {
    state.favorites.add(key);
    btn.classList.add('active');
    btn.textContent = '‚òÖ';
    showToast('Added to favorites');
  }
  
  localStorage.setItem(STORAGE.favorites, JSON.stringify([...state.favorites]));
  
  if (state.filter === 'fav') setTimeout(render, 200);
}

function copyToClipboard(text) {
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    showToast(`Copied: ${text}`);
  });
}

// ================= PRINTER MODAL =================
function openPrinterModal() {
  const modal = document.getElementById('printerModal');
  const list = document.getElementById('printerList');
  
  list.innerHTML = printers.map(p => `
    <div class="printer-item" onclick="copyToClipboard('${p.code}')">
      <div>
        <div class="printer-name">${p.name}</div>
        <div class="printer-loc">${p.loc}</div>
      </div>
      <div class="printer-code">${p.code}</div>
    </div>
  `).join('');
  
  modal.classList.add('active');
}

function closePrinterModal() {
  document.getElementById('printerModal').classList.remove('active');
}

// ================= TOAST =================
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ================= UTILS =================
function makeKey(item) {
  return `${item.category}|${item.service}|${item.extension}`;
}

function escape(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
}

function unescape(str) {
  if (!str) return '';
  const textarea = document.createElement('textarea');
  textarea.innerHTML = str;
  return textarea.value;
}

// ================= EVENTS =================
function setupEvents() {
  const searchInput = document.getElementById('searchInput');
  const searchBox = document.getElementById('searchBox');
  const clearBtn = document.getElementById('clearSearch');
  
  searchInput.addEventListener('input', (e) => {
    state.search = e.target.value;
    searchBox.classList.toggle('has-value', !!e.target.value);
    render();
  });
  
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    state.search = '';
    searchBox.classList.remove('has-value');
    render();
    searchInput.focus();
  });
  
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      state.filter = tab.dataset.filter;
      render();
    });
  });
  
  document.getElementById('printerModal').addEventListener('click', (e) => {
    if (e.target.id === 'printerModal') closePrinterModal();
  });
}

// Start
init();
</script>

</body>
</html>
